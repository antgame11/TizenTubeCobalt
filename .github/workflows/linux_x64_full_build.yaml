---
name: linux_x64_full_build

# This workflow builds Cobalt with libcobalt.so using modular/separate toolchain mode.
# Use this to create a complete build including libcobalt.so that can be reused for faster
# development iterations. The libcobalt.so from this build can be manually placed in the 
# out directory for use with the fast/dev workflow.

on:
  workflow_dispatch:
#   push:
#     tags:
#       - 'v*'

jobs:
  linux-x64-full:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for uploading release assets
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install GN
        run: |
          wget https://chrome-infra-packages.appspot.com/dl/gn/gn/linux-amd64/+/latest -O gn.zip
          unzip gn.zip -d gn_bin
          sudo mv gn_bin/gn /usr/local/bin/gn
          sudo chmod +x /usr/local/bin/gn

      - name: Set PYTHONPATH
        run: |
          echo "PYTHONPATH=$GITHUB_WORKSPACE:$PYTHONPATH" >> $GITHUB_ENV

      - name: Install build dependencies
        run: |
          sudo apt update && sudo apt install -qqy --no-install-recommends \
            bison clang nasm ninja-build ccache python3-venv \
            libgles2-mesa-dev mesa-common-dev libpulse-dev \
            libasound2-dev libxrender-dev libxcomposite-dev libxi-dev
          ccache --max-size=20G

      - name: Download Clang toolchain
        run: bash ./starboard/tools/download_clang.sh

      - name: GN (Modular Build with libcobalt.so)
        run: |
          gn gen out/linux-x64x11_gold --args='
            target_platform="linux-x64x11"
            target_os="linux"
            target_cpu="x64"
            build_type="gold"
            sb_api_version=15
            build_with_separate_cobalt_toolchain=true'
          gn check out/linux-x64x11_gold

      - name: Build libcobalt.so
        run: |
          export NINJA_STATUS="[%e sec | %f/%t %u remaining | %c/sec | j%r] "
          ninja -C out/linux-x64x11_gold cobalt_install

      - name: Package Linux x64 full build
        run: |
          cd out/linux-x64x11_gold
          mkdir -p cobalt-linux-x64-full
          # Copy the libcobalt.so library
          if [ -f "install/lib/libcobalt.so" ]; then
            cp -r install cobalt-linux-x64-full/
          else
            # Fallback to direct copy if install structure differs
            cp -r lib cobalt-linux-x64-full/ || true
            cp -r bin cobalt-linux-x64-full/ || true
          fi
          # Copy content directory
          cp -r content cobalt-linux-x64-full/ || true
          tar -czf cobalt-linux-x64-full.tar.gz cobalt-linux-x64-full
          cd ../..

      - name: Upload Linux x64 full build to release
        # Only upload to release when triggered by a tag push
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: out/linux-x64x11_gold/cobalt-linux-x64-full.tar.gz
          asset_name: cobalt-linux-x64-full.tar.gz
          tag: ${{ github.ref_name }}
          overwrite: true

      - name: Upload libcobalt.so as artifact (for dev use)
        uses: actions/upload-artifact@v4
        with:
          name: libcobalt-so
          path: out/linux-x64x11_gold/install/lib/libcobalt.so
          if-no-files-found: warn
